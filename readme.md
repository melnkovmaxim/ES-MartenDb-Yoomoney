# ES.Yoomoney

Микросервис с Event Sourcing для интеграции с платежной системой Yoomoney.

## Обзор проекта

Это .NET 9.0 микросервис, реализующий паттерн Event Sourcing для обработки платежей через Yoomoney. Он предоставляет
надежное и масштабируемое решение для обработки платежных операций с акцентом на надежность и аудируемость.

## Технологический стек

- .NET 9.0
- Event Sourcing
- CQRS с MediatR
- PostgreSQL
- Kafka
- Yandex.Checkout.V3
- Поддержка Docker

## Детали реализации

### Процесс обработки платежей

1. **Создание счета**
    - Система создает платежный счет через Yandex.Checkout.V3
    - Создает `BankAccountAggregate`, если он не существует
    - Записывает `InvoiceCreatedDomainEvent` в хранилище событий

2. **Обработка платежа**
    - Получает уведомления о платежах через webhook
    - Обрабатывает успешные платежи через `PaymentsPaidProcessingWorker`
    - Записывает `MoneyDepositedDomainEvent` с деталями платежа
    - Обновляет баланс аккаунта

3. **Операции вывода средств**
    - Поддерживает вывод средств через операцию `Withdrawn`
    - Записывает `MoneyWithdrawnDomainEvent`
    - Обновляет баланс аккаунта

### Реализация Event Sourcing

Система использует Event Sourcing для поддержания состояния банковских счетов:

- **Доменные события**:
    - `AccountBalanceInitializedTo`: Инициализация нового аккаунта
    - `InvoiceCreatedDomainEvent`: Запись нового платежного счета
    - `MoneyDepositedDomainEvent`: Запись успешных депозитов
    - `MoneyWithdrawnDomainEvent`: Запись выводов средств

- **Агрегаты**:
    - `BankAccountAggregate`: Управляет состоянием и операциями аккаунта
    - Поддерживает баланс и обрабатывает доменные события
    - Реализует оптимистичную блокировку через версионирование

### Точки интеграции

1. **Интеграция с Yoomoney**
    - Использует клиент Yandex.Checkout.V3
    - Поддерживает создание и захват платежей
    - Обрабатывает webhook уведомления

2. **Шина сообщений**
    - Потоковая обработка событий на основе Kafka
    - Обрабатывает интеграционные события
    - Обеспечивает надежную доставку событий

## Пользовательские сценарии

### Основные операции

- [ ] **Создание платежа**
    - Создание счета через Yandex.Checkout.V3
    - Обработка уведомлений об оплате
    - Обновление баланса аккаунта

- [ ] **Проверка статуса платежа**
    - Запрос статуса по ID платежа
    - Получение детальной информации
    - Проверка прав доступа

- [ ] **Вывод средств**
    - Проверка баланса и лимитов
    - Создание операции вывода
    - Обновление баланса и истории

- [ ] **Просмотр истории операций**
    - Фильтрация по периоду и типу
    - Пагинация результатов
    - Экспорт данных